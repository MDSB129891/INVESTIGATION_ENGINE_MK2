#!/usr/bin/env bash
set -euo pipefail

TICKER="${1:-}"
THESIS="${2:-}"

if [ -z "$TICKER" ] || [ -z "$THESIS" ]; then
  echo ""
  echo "Usage:"
  echo '  JARVIS TICKER "your thesis here"'
  echo ""
  exit 1
fi

TICKER_UPPER="$(echo "$TICKER" | tr '[:lower:]' '[:upper:]')"
CANON="export/CANON_${TICKER_UPPER}"

echo ""
echo "ðŸ§  JARVIS ONLINE"
echo "Ticker: $TICKER_UPPER"
echo "Thesis: $THESIS"
echo ""

mkdir -p theses export outputs "$CANON"

# 1) Write thesis file (Jarvis)
cat > "theses/${TICKER_UPPER}_jarvis.json" <<JSON
{
  "ticker": "$TICKER_UPPER",
  "name": "Jarvis thesis",
  "description": "$THESIS",
  "claims": []
}
JSON

echo "âœ… JARVIS thesis file: theses/${TICKER_UPPER}_jarvis.json"
echo ""

# 2) Full engine (pass thesis path into THANOS so everything uses it)
./scripts/run_thanos.sh "$TICKER_UPPER" "theses/${TICKER_UPPER}_jarvis.json"

# 3) SUPERPLUS CLEAN memo (already PDF)
python3 scripts/build_superplus_clean.py \
  --ticker "$TICKER_UPPER" \
  --thesis "theses/${TICKER_UPPER}_jarvis.json"

# 4) HUD + Time Machine
python3 scripts/build_ironman_hud.py --ticker "$TICKER_UPPER" || true
python3 scripts/build_time_machine.py --ticker "$TICKER_UPPER" || true

# 5) FRIDAY modules (extra crunchy)
python3 scripts/friday/build_core_metrics.py --ticker "$TICKER_UPPER" || true
python3 scripts/friday/build_free_news.py --ticker "$TICKER_UPPER" || true
python3 scripts/friday/build_decision_core.py --ticker "$TICKER_UPPER" || true

# 6) DCF
python3 scripts/build_dcf_engine.py --ticker "$TICKER_UPPER" || true

# 7) Move deliverables into CANON (ignore missing)
mv -f "export/${TICKER_UPPER}_SUPERPLUS_CLEAN_Memo.pdf" "$CANON/" 2>/dev/null || true
mv -f "export/${TICKER_UPPER}_Full_Investment_Memo.pdf" "$CANON/" 2>/dev/null || true
mv -f "outputs/decision_dashboard_${TICKER_UPPER}.html" "$CANON/" 2>/dev/null || true
mv -f "outputs/news_clickpack_${TICKER_UPPER}.html" "$CANON/" 2>/dev/null || true
mv -f "outputs/claim_evidence_${TICKER_UPPER}.html" "$CANON/" 2>/dev/null || true
mv -f "outputs/alerts_${TICKER_UPPER}.json" "$CANON/" 2>/dev/null || true
mv -f "outputs/veracity_${TICKER_UPPER}.json" "$CANON/" 2>/dev/null || true

# These are already written into CANON by some scripts, but harmless to "mv -f" anyway
mv -f "export/${TICKER_UPPER}_IRONMAN_HUD.html" "$CANON/" 2>/dev/null || true
mv -f "export/${TICKER_UPPER}_TIME_MACHINE.html" "$CANON/" 2>/dev/null || true
mv -f "export/${TICKER_UPPER}_DCF.json" "$CANON/" 2>/dev/null || true

echo ""
echo "ðŸš€ JARVIS COMPLETE â€” CANON:"
ls -lh "$CANON" | sed -n '1,120p'
echo ""

echo "OPENING (WAKANDA CORE):"
# Open only what exists (prevents annoying errors)
[ -f "$CANON/decision_dashboard_${TICKER_UPPER}.html" ] && /usr/bin/open "$CANON/decision_dashboard_${TICKER_UPPER}.html" || true
[ -f "$CANON/${TICKER_UPPER}_DECISION_CORE.html" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_DECISION_CORE.html" || true
[ -f "$CANON/${TICKER_UPPER}_SUPERPLUS_CLEAN_Memo.pdf" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_SUPERPLUS_CLEAN_Memo.pdf" || true
[ -f "$CANON/${TICKER_UPPER}_IRONMAN_HUD.html" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_IRONMAN_HUD.html" || true
[ -f "$CANON/${TICKER_UPPER}_TIME_MACHINE.html" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_TIME_MACHINE.html" || true
[ -f "$CANON/${TICKER_UPPER}_FREE_NEWS.html" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_FREE_NEWS.html" || true
[ -f "$CANON/${TICKER_UPPER}_CORE_METRICS.html" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_CORE_METRICS.html" || true

# Optional: long memo
[ -f "$CANON/${TICKER_UPPER}_Full_Investment_Memo.pdf" ] && /usr/bin/open "$CANON/${TICKER_UPPER}_Full_Investment_Memo.pdf" || true

echo ""
echo "âœ… DONE"
