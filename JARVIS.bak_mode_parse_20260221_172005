#!/usr/bin/env bash
set -euo pipefail

TICKER="${1:-}"
THESIS_INPUT="${2:-}"   # thesis.json OR plain english string
MODE="${3:-mini}"       # mini | all

if [ -z "$TICKER" ]; then
  echo "usage: ./JARVIS TICKER [thesis.json | \"thesis string\"] [mini|all]"
  exit 1
fi

ROOT="$(cd "$(dirname "$0")" && pwd)"
T="$(printf "%s" "$TICKER" | tr '[:lower:]' '[:upper:]')"

echo "ü§ñ JARVIS (VISION) ‚Äî ${T} | mode=${MODE}"

# ------------------------------
# 1) Handle thesis override
# ------------------------------

THESIS_OVERRIDE=""

if [ -n "$THESIS_INPUT" ]; then
  if [ -f "$THESIS_INPUT" ] && [[ "$THESIS_INPUT" == *.json ]]; then
    THESIS_OVERRIDE="$THESIS_INPUT"
  else
    mkdir -p "$ROOT/theses/_overrides"
    THESIS_OVERRIDE="$ROOT/theses/_overrides/${T}_override_thesis.json"

    echo "üß† generating thesis override from string..."
    python3 "$ROOT/scripts/make_thesis_from_string.py" \
      --ticker "$T" \
      --thesis "$THESIS_INPUT" \
      --out "$THESIS_OVERRIDE"
  fi
fi

if [ -n "$THESIS_OVERRIDE" ]; then
  echo "üß† thesis override: $THESIS_OVERRIDE"
else
  echo "üß† thesis override: <none>"
fi

# ------------------------------
# 2) Run full engine (THANOS)
# ------------------------------

if [ -n "$THESIS_OVERRIDE" ]; then
  THESIS_OVERRIDE="$THESIS_OVERRIDE" bash "$ROOT/scripts/run_thanos.sh" "$T"
else
  bash "$ROOT/scripts/run_thanos.sh" "$T"
fi

# ------------------------------
# 3) Open artifacts
# ------------------------------

hud="$ROOT/export/CANON_${T}/${T}_IRONMAN_HUD.html"
timestone="$ROOT/export/CANON_${T}/${T}_TIMESTONE.html"
claims="$ROOT/outputs/claim_evidence_${T}.html"
news="$ROOT/outputs/news_clickpack_${T}.html"
receipts="$ROOT/outputs/receipts_${T}.html"

pdf="$ROOT/export/${T}_Full_Investment_Memo.pdf"
ultra="$ROOT/export/${T}_ULTRA_Memo.docx"
superpdf="$ROOT/export/${T}_SUPER_PLUS_Memo.pdf"
superdocx="$ROOT/export/${T}_SUPER_PLUS_Memo.docx"

open_if() {
  local f="$1"
  if [ -f "$f" ]; then
    echo "üöÄ opening: $f"
    open "$f" >/dev/null 2>&1 || true
  else
    echo "‚ö†Ô∏è missing: $f"
  fi
}

# MINI = cockpit + best memo
open_if "$hud"

if [ -f "$superpdf" ]; then
  open_if "$superpdf"
else
  open_if "$pdf"
fi

# ALL = everything
if [ "$MODE" = "all" ]; then
  open_if "$timestone"
  open_if "$claims"
  open_if "$news"
  open_if "$receipts"
  open_if "$superdocx"
  open_if "$ultra"
fi
