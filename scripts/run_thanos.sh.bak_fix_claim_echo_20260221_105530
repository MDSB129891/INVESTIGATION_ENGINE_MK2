#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."

TICKER="${1:-UBER}"
ACTIVE_THESIS="${2:-theses/${TICKER}_thesis_base.json}"

echo "üü£ THANOS RUN: ${TICKER}"
echo "Thesis override: ${ACTIVE_THESIS:-<none>}"
BASE_THESIS="theses/${TICKER}_thesis_base.json"
ACTIVE_THESIS="${THESIS_OVERRIDE:-$BASE_THESIS}"
echo "Thesis used: ${ACTIVE_THESIS}"


# Universe: you can change peers here if you want (or pass UNIVERSE env)
export UNIVERSE="${UNIVERSE:-${TICKER},LYFT,DASH}"

echo "=== 1) Engine update (financials + news) ==="
python3 scripts/run_uber_update.py

# --- GALACTUS: force shared summary to match this ticker (prevents ticker mismatch) ---
if [ -f "outputs/decision_summary_${TICKER}.json" ]; then
  cp "outputs/decision_summary_${TICKER}.json" "outputs/decision_summary.json"
fi
if [ -f "outputs/decision_explanation_${TICKER}.json" ]; then
  cp "outputs/decision_explanation_${TICKER}.json" "outputs/decision_explanation.json"
fi


echo "=== 2) Thesis suite (bear/base/bull) ==="
python3 scripts/generate_thesis_suite.py --ticker "${TICKER}"

echo "=== 3) Veracity pack (confidence + clickpack) ==="
python3 scripts/build_veracity_pack.py --ticker "${TICKER}"

echo "=== 4) Alerts (thesis breakers + red lines) ==="
python3 scripts/build_alerts.py --ticker "${TICKER}"

echo "=== 4.5) Claim evidence (Stormbreaker) ==="
python3 scripts/build_claim_evidence.py --ticker "$TICKER" --thesis "${ACTIVE_THESIS}" echo "=== 5) Full memo (novice friendly + verdict + scenarios) ==="
if [[ -n "${ACTIVE_THESIS}" ]]; then
  python3 scripts/build_investment_memo.py --ticker "${TICKER}" --thesis "${ACTIVE_THESIS}"
else
  python3 scripts/build_investment_memo.py --ticker "${TICKER}"
fi

echo "=== 5a) Calculation methodology (formulas + worked example) ==="
python3 scripts/build_calculation_methodology.py --ticker "${TICKER}"


echo "=== 5b) Export PDF ==="
python3 scripts/export_pdf.py --ticker "${TICKER}"

echo "=== 6) One-page dashboard (links everything) ==="

echo ""
echo "=== 7) Time Stone (history view over time) ==="
python3 scripts/build_timestone.py --ticker "$TICKER" || true

python3 scripts/generate_dashboard.py --ticker "${TICKER}"

echo ""
echo "DONE ‚úÖ THANOS PACK:"
echo "- outputs/news_clickpack_${TICKER}.html"
echo "- outputs/veracity_${TICKER}.json"
echo "- outputs/alerts_${TICKER}.json"
echo "- outputs/decision_dashboard_${TICKER}.html"
echo "- export/${TICKER}_Full_Investment_Memo.docx"
echo "- outputs/${TICKER}_Calculation_Methodology.md"
echo "- export/${TICKER}_Calculation_Methodology.docx"
echo ""

# [JARVIS] muted duplicate open: open "outputs/decision_dashboard_${TICKER}.html" || true
# [JARVIS] muted duplicate open: open "export/${TICKER}_Full_Investment_Memo.docx" || true


echo "=== X) ULTRA memo (novice / explain-everything) ==="
# ULTRA requires --thesis. Prefer override if provided, else base thesis.
BASE_THESIS="theses/${TICKER}_thesis_base.json"

if [ -n "${THESIS_OVERRIDE:-}" ] && [ -f "${THESIS_OVERRIDE}" ]; then
  python3 scripts/build_ultra_memo.py --ticker "$TICKER" --thesis "${THESIS_OVERRIDE}" || true
elif [ -f "${BASE_THESIS}" ]; then
  python3 scripts/build_ultra_memo.py --ticker "$TICKER" --thesis "${BASE_THESIS}" || true
else
  echo "‚ö†Ô∏è ULTRA skipped: no thesis file found (need ${BASE_THESIS} or THESIS_OVERRIDE)"
fi

echo ""
echo "üöÄ OPENING ULTRA RESULTS"
open "export/${TICKER}_ULTRA_Memo.docx" || true


echo ""
echo "=== Y) SUPER+ memo (storytime, funniest + most hand-holding) ==="
BASE_THESIS="theses/${TICKER}_thesis_base.json"

THESIS_FOR_SUPER=""
if [ -n "${THESIS_OVERRIDE:-}" ] && [ -f "${THESIS_OVERRIDE}" ]; then
  THESIS_FOR_SUPER="${THESIS_OVERRIDE}"
elif [ -f "${BASE_THESIS}" ]; then
  THESIS_FOR_SUPER="${BASE_THESIS}"
fi

if [ -n "${THESIS_FOR_SUPER}" ]; then
  # build SUPER+ (docx)
  python3 scripts/build_super_plus.py --ticker "$TICKER" --thesis "${THESIS_FOR_SUPER}" || true

  # convert to pdf if soffice exists
  SUPER_DOCX="export/${TICKER}_SUPER_PLUS_Memo.docx"
  if [ -f "${SUPER_DOCX}" ]; then
    if command -v soffice >/dev/null 2>&1; then
      soffice --headless --convert-to pdf --outdir export "${SUPER_DOCX}" >/dev/null 2>&1 || true
      echo "‚úÖ SUPER+ PDF attempted: export/${TICKER}_SUPER_PLUS_Memo.pdf"
    else
      echo "‚ö†Ô∏è soffice not found; SUPER+ PDF skipped"
    fi
  fi
else
  echo "‚ö†Ô∏è SUPER+ skipped: no thesis file found (need ${BASE_THESIS} or THESIS_OVERRIDE)"
fi

